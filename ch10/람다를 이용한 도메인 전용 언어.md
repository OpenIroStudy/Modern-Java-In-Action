# 람다를 이용한 도메인 전용 언어
언어의 주요 목표는 메시지를 명확하고, 안정적인 방식으로 전달하는 것.

도메인 특화 언어(DSL)란?
도메인 특화 언어는 관련 특정 분야에 최적화된 프로그래밍 언어. DSL은 해당 분야 또는 도메인의 개념과 규칙을 사용한다.
Ex) 메이븐, 엔트 -> 빌드 과정을 표현하는 DSL.
Ex) HTML -> 웹 페이지의 구조를 정의하도록 특화된 언어.


도메인 특화 언어(DSL)는 일반적으로 Java, C, Ruby 등의 범용 언어보다 덜 복잡하다. 보통 DSL은 해당 DSL이 사용될 분야의 전문가와 긴밀하게 협력하여 개발한다. 대부분의 경우 DSL은 소프트웨어 전문가가 아닌, 해당 DSL의 대상 분야에 능통한 비 프로그래머가 사용하도록 제작된다.

* 플루언트 스타일(메서드 체인 패턴)
  * 스트림의 API의 특성인 메서드 체인을 보통 자바의 루프의 복잡함 제어와 비교해 유창함을 의미.
  * 메소드 체이닝에 상당 부분 기반한 객체 지향 API 설계 메소드이며, 소스 코드의 가독성을 산문과 유사하게 만드는 것이 목적.
  * Fluent API : 함수들을 작성하고 나면, 마치 그 문장이 영어 문장처럼 읽히는 API.

DSL은 두 가지 필요성을 생각하면서 개발해야 한다.

1. 우리의 코드가 명확히 전달되어야 하며 프로그래머가 아닌 사람도 이해할 수 있어야 한다. 이런 방식으로 코드가 비즈니스 요구사항에 부합하는지 확인할 수 있다.
2. 가독성은 유지보수의 핵심이다. 즉 항상 우리의 동료가 쉽게 이해할 수 있도록 코드를 구현해야 한다.

## DSL의 장점
* 간결함
: API는 비즈니스 로직을 간편하게 캡슐화하므로 반복을 피할 수 있고 코드를 간결하게 할 수 있다.
* 가독성
: 도메인 용역의 용어를 사용하므로 비 도메인 전문가도 코드를 쉽게 이해할 수 있다.
* 유지보수
: 잘 설계된 DSL로 구현한 코드는 쉽게 유지보수하고 바꿀 수 있다.
* 높은 수준의 추상화
: DSL은 도메인과 같은 추상화 수준에서 동작하므로 도메인의 문제와 직접적으로 관련되지 않은 세부 사항을 숨긴다.
* 집중
: 비즈니스 도메인의 규칙을 표현할 목적으로 설계된 언어이므로 프로그래머가 특정 코드에 집중할 수 있다.
* 관심사 분리
: 지정된 언어로 비즈니스 로직을 표현함으로 애플리케이션의 인프라구조와 관련된 문제와 독립적으로 비즈니스 관련된 코드에서 집중하기가 용이하다.

## DSL의 단점
* DSL 설계의 어려움
: 간결하게 제한적인 언어에 도메인 지식을 담는 것이 쉬운 작업은 아니다.
* 개발 비용
: 코드에 DSL을 추가하는 작업은 초기 프로젝트에 많은 비용과 시간이 소모되는 작업이다.
* 추가 우회 계층
: DSL은 추가적인 계층으로 도메인 모델을 감싸며 이 때 계층을 최대한 작게 만들어 성능 문제를 회피한다.
* 새로 배워야 하는 언어
* 호스팅 언어 한계
: 일부 자바 같은 범용 프로그래밍 언어는 장황하고 엄격한 문법을 가졌다. 이런 언어로는 사용자 친화적 DSL을 만들기가 힘들다.

## JVM에서 이용할 수 있는 다른 DSL 해결책
DSL의 카테고리를 구분하는 가장 흔한 방법은 내부 DSL과 외부 DSL을 나누는 것이다.

내부 DSL(임베디드 DSL)은 순수 자바 코드 같은 기존 호스팅 언어를 기반으로 구현하는 반면, 스탠드어론(stand alone)이라 불리는 외부 DSL은 호스팅 언어와는 독립적으로 자체의 문법을 가진다.

JVM에서 실행되며 더 유연하고 표현력이 강력한 언어도 있다. (다중 DSL)

### 내부 DSL
내부 DSL이란 자바로 구현한 DSL을 의미한다.

자바는 표현력 있는 DSL을 만드는데 한계가 있었다. 람다 표현식이 등장하면서 이 문제가 어느정도 해결될 수 있다.

순수 자바로 DSL을 구현함으로 다음과 같은 장점을 얻을 수 있다.

* 외부 DSL에 비해 새로운 패턴과 기술을 배워 DSL을 구현하는 노력이 현저하게 줄어든다.
* 순수 자바로 DSL을 구현하면 나머지 코드와 함께 DSL을 컴파일 할 수 있다. 외부 DSL을 만드는 도구를 사용할 필요가 없으므로 추가로 비용이 들지 않는다.
* DSL 사용자는 기존의 자바 IDE를 이용해 자동 완성, 자동 리팩터링 같은 기능을 그대로 사용.
* 추가 DSL을 쉽게 합칠 수 있다.

### 다중 DSL
같은 자바 바이트코드를 사용하여 JVM 기반 프로그래밍 언어를 이용함으로 DSL 합칠 수 있다.

다른 언어를 사용함으로 자바로는 결과를 얻기 어려운 것을 얻을 수 있다.

하지만 이 접근 방법은 다음과 같은 불편함도 초래한다.

* 새로운 프로그래밍 언어를 배우거나 또는 팀의 누군가가 이미 해당 기술을 가지고 있어야 한다.
* 두 개 이사으이 언어가 혼재하므로 여러 컴파일러로 소스를 빌드하도록 빌드 과정을 개선해야 한다.
* JVM에서 실행되지만 자바와 완벽하게 호환이 되지 않을 때가 많다.

### 외부 DSL
외부 DSL을 개발하는 가장 큰 장점은 외부 DSL이 제공하는 무한한 유연성이다.

우리에게 필요한 특성을 완벽하게 제공하는 언어를 설계할 수 있다는 것이 장점이다.

자바로 개발된 인프라구조 코드와 외부 DSL로 구현한 비즈니스 코드를 명확하게 분리한다는 것도 장점이다.
(하지만 이 분리로 인해 DSL과 호스트 언어 사이에 인공계층이 생긴다.)

외부 DSL의 예시는 SQL을 떠올려 보면 된다.

**내부적DSL(개발언어 그대로 사용) / 외부적DSL(직접 언어설계) / 다중DSL(여러언어 섞어서사용)**

## 최신 자바 API의 작은 DSL
람다와 메서드 참조를 이용하여 코드의 신호 대비 잡음 비율을 줄일 수 있다.

```
Collections.sort(persons, comparing(Person::getAge));
```
이 작은 API는 컬렉션 정렬 도메인의 최소 DSL이다. 작은 영역에 국한된 예제지만 이미 람다와 메서드 참조를 이용한 DSL이 코드의 가독성, 재사용성, 결합성을 높일 수 있는지 보여준다.

### 스트림 API는 컬렉션을 조작하는 DSL
Stream 인터페이스는 네이티브 자바 API에 작은 내부 DSL을 적용한 좋은 예다.

Stream은 컬렉션의 항목을 필터, 정렬, 변환, 그룹화, 조작하는 작지만 강력한 DSL로 볼 수 있다.

### 대이터를 수집하는 DSL인 Collectors
Stream 인터페이스를 데이터 리스트를 조작하는 DSL로 간주할 수 있음을 확인했다.

마찬가지로 Collector 인터페이스는 데이터 수집을 수행하는 DSL로 간주할 수 있다.

## 자바로 DSL을 만드는 패턴과 기법
### 메서드 체인
- 메서드 체인을 통해 객체를 만든다.
- 플루언트 API로 도메인 객체를 만드는 몇 개의 빌더를 구현해야 한다.
- 사용자가 미리 지정된 절차에 따라 설정하도록 한다.
- 사용한 파라미터가 빌더 내부로 국한된다.
- 정적 메서드 사용을 최소화하고 메서드 이름이 인수의 이름을 대신하도록 만들어 가독성이 좋다.
- 빌더를 구현하여야만 한다.

### 중첩된 함수 이용
- 다른 함수 안에 함수를 이용하여 도메인 모델을 만든다.
- DSL에 더 많은 괄호를 사용해야 한다.
- 인수 목록을 정적 메서드에 넘겨주어야 한다.
- 인수의 의미가 이름이 아니라 위치에 의해 정의된다.

### 람다 표현식을 이용한 함수 시퀀싱
- 메서드 체인 패턴처럼 플루언트 방식으로 정의 가능하다.
- 중첩 함수 형식처럼 람다 표현식의 중첩 수준과 비슷하게 도메인 객체의 계층 구조를 유지한다.
- 많은 설정 코드가 필요하며, 람다 표현식 문법에 의한 잡음의 영향을 받는다.

## 자바 8 DSL

<img width="1014" alt="스크린샷 2022-04-27 오후 11 43 53" src="https://user-images.githubusercontent.com/82895809/165545102-b332efb3-c6fd-4aa2-ad89-0b7be28fef48.png">

### jOOQ
```
SELECT * FROM BOOK
WHERE BOOK.PUBLISHED_IN = 2016
ORDER BY BOOK.TITLE

////////////////////////////

create.selectFrom(BOOK)
      .where(BOOK.PUBLISHED_IN.eq(2016))
      .orderBy(BOOK.TITLE)

```

플루언트 구문으로 데이터를 메모리에서 조작

### 큐컴버
동작 주도 개발 프레임워크

개발자가 비즈니스 시나리오를 평문 영어로 구현할 수 있도록 도와주는 도구

### 스프링 통합
엔터프라이즈 통합패턴을 지원할 수 있도록 의존성 주입에 기반한 스프링 프로그래밍 모델을 확장.

단순한 모델을 제공하고 비동기, 메시지 주도 아키텍처를 쉽게 적용하도록 도움.

스프링 통합 DSL에서 가장 널리 사용하는 패턴은 메서드 체인이다.
하지만 최상위 객체를 만들 때는 함수 시퀀싱과 람다 표현식을 사용한다.

-----------------------

* DSL의 주요 기능은 개발자와 도메인 전문가 사이의 간격을 좁히는 것이다.

* DSL은 크게 내부적(DSL이 사용될 애플리케이션을 개발한 언어를 그대로 활용) DSL과 외부적(직접 언어를 설계해 사용함) DSL로 분류할 수 있다. 내부적 DSL은 개발 노력이 적게 드는 반면 호스팅 언어의 문법 제약을 받는다.
외부적 DSL은 높은 유연성을 제공하지만 구현하기가 어렵다.

* 자바는 내부적 DSL을 개발하는 언어로는 적합하지 않지만 람다 표현식과 메서드 참조 덕분에 상황이 많이 개선됐다.

* 자바로 DSL을 구현할 때 보통 메서드 체인, 중첩 함수, 함수 시퀀싱 세 가지 패턴이 사용된다. 각각의 패턴은 장단점이 있지만 모든 기법을 한 개의 DSL에 합쳐 장점만을 누릴 수 있다.

* 많은 자바 프레임워크와 라이브러리를 DSL을 통해 이용할 수 있다.(SQL 매핑 도구인 jOOQ, BDD 프레임 워크 큐컴버, 엔터프라이즈 통합 패턴을 구현한 스프링 확장인 스프링 통합)
